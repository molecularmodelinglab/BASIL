name: Build and Release (Universal Binary)

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
  pull_request:
    branches: [main]

jobs:
  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        architecture: [x86, x64]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install UPX
        run: choco install upx

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install poetry
          poetry install

      - name: Build application
        run: |
          poetry run python build.py --version ${{ github.event.inputs.version || github.event.release.tag_name || '1.0.0' }} --tag-output --clean

      - name: Create Inno Setup script
        run: |
          $version = "${{ github.event.inputs.version || github.event.release.tag_name || '1.0.0' }}"
          $appFolder = "dist\BASIL-v$version"

          @"
          [Setup]
          AppName=BASIL
          AppVersion=$version
          AppPublisher=BASIL
          DefaultDirName={autopf}\BASIL
          DefaultGroupName=BASIL
          OutputDir=dist
          OutputBaseFilename=BASIL-setup-${{ matrix.architecture }}
          Compression=lzma2
          SolidCompression=yes
          ArchitecturesAllowed=${{ matrix.architecture == 'x64' && 'x64' || '' }}
          ArchitecturesInstallIn64BitMode=${{ matrix.architecture == 'x64' && 'x64' || '' }}

          [Files]
          Source: "$appFolder\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs

          [Icons]
          Name: "{group}\BASIL"; Filename: "{app}\BASIL.exe"
          Name: "{autodesktop}\BASIL"; Filename: "{app}\BASIL.exe"; Tasks: desktopicon

          [Tasks]
          Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked
          "@ | Out-File -FilePath "setup.iss" -Encoding ASCII

      - name: Build Windows installer with Inno Setup
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "setup.iss"

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.architecture }}
          path: dist/BASIL-setup-${{ matrix.architecture }}.exe

  build-macos-arm64:
    runs-on: macos-14  # Apple Silicon runner
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install UPX
        run: brew install upx

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install poetry
          poetry install

      - name: Build ARM64 application
        run: |
          VERSION=${{ github.event.inputs.version || github.event.release.tag_name || '1.0.0' }}
          poetry run python build.py --version $VERSION --tag-output --clean --bundle-id com.basil.app

          # Rename to indicate architecture
          mv "dist/BASIL-v${VERSION}.app" "dist/BASIL-v${VERSION}-arm64.app"

      - name: Create tar archive (preserves symlinks)
        run: |
          VERSION=${{ github.event.inputs.version || github.event.release.tag_name || '1.0.0' }}
          cd dist
          # Use tar with -h flag to follow symlinks for the executable only
          # But preserve symlinks in the archive
          tar -czf BASIL-v${VERSION}-arm64.tar.gz "BASIL-v${VERSION}-arm64.app"

          # Verify symlinks are in the archive
          echo "=== Checking archive contents ==="
          tar -tzf BASIL-v${VERSION}-arm64.tar.gz | grep "Frameworks" | head -10

      - name: Upload ARM64 build
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-build
          path: dist/*.tar.gz

  build-macos-intel:
    runs-on: macos-13  # Intel runner
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install UPX
        run: brew install upx

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install poetry
          poetry install

      - name: Build x86_64 application
        run: |
          VERSION=${{ github.event.inputs.version || github.event.release.tag_name || '1.0.0' }}
          poetry run python build.py --version $VERSION --tag-output --clean --bundle-id com.basil.app

          # Rename to indicate architecture
          mv "dist/BASIL-v${VERSION}.app" "dist/BASIL-v${VERSION}-x86_64.app"

      - name: Create tar archive (preserves symlinks)
        run: |
          VERSION=${{ github.event.inputs.version || github.event.release.tag_name || '1.0.0' }}
          cd dist
          tar -czf BASIL-v${VERSION}-x86_64.tar.gz "BASIL-v${VERSION}-x86_64.app"

          # Verify symlinks are in the archive
          echo "=== Checking archive contents ==="
          tar -tzf BASIL-v${VERSION}-x86_64.tar.gz | grep "Frameworks" | head -10

      - name: Upload Intel build
        uses: actions/upload-artifact@v4
        with:
          name: macos-intel-build
          path: dist/*.tar.gz

  create-universal-binary:
    needs: [build-macos-arm64, build-macos-intel]
    runs-on: macos-14
    steps:
      - name: Download ARM64 build
        uses: actions/download-artifact@v4
        with:
          name: macos-arm64-build
          path: dist-arm64/

      - name: Download Intel build
        uses: actions/download-artifact@v4
        with:
          name: macos-intel-build
          path: dist-intel/

      - name: Extract archives
        run: |
          VERSION=${{ github.event.inputs.version || github.event.release.tag_name || '1.0.0' }}

          cd dist-arm64
          tar -xzf BASIL-v${VERSION}-arm64.tar.gz

          cd ../dist-intel
          tar -xzf BASIL-v${VERSION}-x86_64.tar.gz

          cd ..

          # Verify symlinks are preserved after extraction
          echo "=== ARM64 symlinks ==="
          ls -la "dist-arm64/BASIL-v${VERSION}-arm64.app/Contents/Frameworks/" | grep "^l" | head -5
          echo "=== Intel symlinks ==="
          ls -la "dist-intel/BASIL-v${VERSION}-x86_64.app/Contents/Frameworks/" | grep "^l" | head -5

      - name: Create Universal Binary
        run: |
          VERSION=${{ github.event.inputs.version || github.event.release.tag_name || '1.0.0' }}

          ARM64_APP="dist-arm64/BASIL-v${VERSION}-arm64.app"
          INTEL_APP="dist-intel/BASIL-v${VERSION}-x86_64.app"

          echo "ARM64 app: $ARM64_APP"
          echo "Intel app: $INTEL_APP"

          # Create universal app structure by copying ARM64 as base
          # CRITICAL: Use -a to preserve symlinks
          mkdir -p dist
          cp -a "$ARM64_APP" "dist/BASIL-v${VERSION}.app"

          # Get the executable name
          EXEC_NAME=$(ls "$ARM64_APP/Contents/MacOS/" | grep -v "^\\." | head -n 1)
          echo "Executable name: $EXEC_NAME"

          # Verify files exist
          if [ ! -f "$ARM64_APP/Contents/MacOS/$EXEC_NAME" ]; then
            echo "ERROR: ARM64 executable not found"
            exit 1
          fi

          if [ ! -f "$INTEL_APP/Contents/MacOS/$EXEC_NAME" ]; then
            echo "ERROR: Intel executable not found"
            exit 1
          fi

          # Create universal binary using lipo
          lipo -create \
            "$ARM64_APP/Contents/MacOS/$EXEC_NAME" \
            "$INTEL_APP/Contents/MacOS/$EXEC_NAME" \
            -output "dist/BASIL-v${VERSION}.app/Contents/MacOS/$EXEC_NAME"

          # Restore executable permissions
          chmod +x "dist/BASIL-v${VERSION}.app/Contents/MacOS/$EXEC_NAME"

          # Fix Info.plist
          PLIST_PATH="dist/BASIL-v${VERSION}.app/Contents/Info.plist"
          if [ -f "$PLIST_PATH" ]; then
            echo "Updating Info.plist for universal binary..."
            /usr/libexec/PlistBuddy -c "Delete :LSArchitecturePriority" "$PLIST_PATH" 2>/dev/null || true
            /usr/libexec/PlistBuddy -c "Delete :LSRequiresNativeExecution" "$PLIST_PATH" 2>/dev/null || true
            /usr/libexec/PlistBuddy -c "Set :CFBundleExecutable $EXEC_NAME" "$PLIST_PATH" 2>/dev/null || true
            /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION" "$PLIST_PATH" 2>/dev/null || true
            /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $VERSION" "$PLIST_PATH" 2>/dev/null || true
          fi

          # Verify the universal binary
          echo "=== Universal binary info ==="
          lipo -info "dist/BASIL-v${VERSION}.app/Contents/MacOS/$EXEC_NAME"
          file "dist/BASIL-v${VERSION}.app/Contents/MacOS/$EXEC_NAME"

          # CRITICAL: Verify symlinks are STILL preserved
          echo "=== Final symlink check ==="
          ls -la "dist/BASIL-v${VERSION}.app/Contents/Frameworks/" | grep "^l" | head -5

      - name: Remove Quarantine Attributes
        run: |
          VERSION=${{ github.event.inputs.version || github.event.release.tag_name || '1.0.0' }}
          APP_PATH="dist/BASIL-v${VERSION}.app"

          echo "=== Removing quarantine attributes ==="
          xattr -cr "$APP_PATH" 2>/dev/null || true

      - name: Install DMG creator
        run: brew install create-dmg

      - name: Create DMG
        run: |
          VERSION=${{ github.event.inputs.version || github.event.release.tag_name || '1.0.0' }}

          # Create DMG directory
          mkdir -p dist/dmg
          # CRITICAL: Use -a flag to preserve symlinks
          cp -a "dist/BASIL-v${VERSION}.app" dist/dmg/BASIL.app

          # Final symlink verification before DMG creation
          echo "=== Verifying symlinks before DMG creation ==="
          ls -la dist/dmg/BASIL.app/Contents/Frameworks/ | grep "^l" | head -5

          # Check sizes
          echo "=== Size check ==="
          du -sh dist/dmg/BASIL.app/Contents/Frameworks
          du -sh dist/dmg/BASIL.app/Contents/Resources

          # Create DMG
          create-dmg \
            --volname "BASIL" \
            --no-internet-enable \
            "dist/BASIL-v${VERSION}-universal.dmg" \
            "dist/dmg/"

      - name: Upload macOS universal artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-universal
          path: dist/*.dmg

  build-linux:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:20.04
      options: --user root
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y \
            software-properties-common \
            wget \
            fuse \
            libfuse2 \
            desktop-file-utils \
            file
          # Add deadsnakes PPA for newer Python on old Ubuntu
          add-apt-repository ppa:deadsnakes/ppa -y
          apt-get update

      - name: Install Python 3.11
        run: |
          apt-get install -y \
            python3.11 \
            python3.11-dev \
            python3.11-venv \
            python3-pip

      - name: Set up Python environment
        run: |
          python3.11 -m pip install --upgrade pip
          python3.11 -m pip install poetry

      - name: Install UPX
        run: |
          # Install UPX (though PyInstaller may not use it on Linux)
          apt-get install -y upx-ucl || apt-get install -y upx

      - name: Install dependencies
        run: |
          poetry install

      - name: Build Linux application
        run: |
          VERSION=${{ github.event.inputs.version || github.event.release.tag_name || '1.0.0' }}
          poetry run python build.py --version $VERSION --tag-output --clean

          # Check GLIBC requirement
          echo "=== GLIBC requirement check ==="
          ldd "dist/BASIL-v${VERSION}/BASIL" | grep libc || true
          objdump -T "dist/BASIL-v${VERSION}/BASIL" | grep GLIBC | sort -u || true

      - name: Download AppImage tools
        run: |
          wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

      - name: Create AppImage structure
        run: |
          VERSION=${{ github.event.inputs.version || github.event.release.tag_name || '1.0.0' }}

          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/lib
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps

          # Copy all application files (onedir mode)
          cp -r dist/BASIL-v${VERSION}/* AppDir/usr/bin/

          # Find and copy Python shared libraries to usr/lib
          echo "=== Looking for Python libraries ==="
          find AppDir/usr/bin -name "libpython*.so*" -exec cp {} AppDir/usr/lib/ \;
          find AppDir/usr/bin -name "*.so*" | head -20

          # Copy icons
          if [ -f assets/icons/icon.png ]; then
            cp assets/icons/icon.png AppDir/usr/share/icons/hicolor/256x256/apps/basil.png
            cp assets/icons/icon.png AppDir/basil.png
          fi

          # Create desktop entry
          cat > AppDir/usr/share/applications/basil.desktop << EOF
          [Desktop Entry]
          Name=BASIL
          Exec=BASIL
          Icon=basil
          Type=Application
          Categories=Science;Education;
          Terminal=false
          Comment=BASIL Application
          EOF

          # Copy to root for appimagetool
          cp AppDir/usr/share/applications/basil.desktop AppDir/basil.desktop
          desktop-file-validate AppDir/basil.desktop || true

          # Create AppRun with proper library paths
          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}

          # Add all library paths
          export LD_LIBRARY_PATH="${HERE}/usr/lib:${HERE}/usr/bin:${HERE}/usr/bin/lib:${LD_LIBRARY_PATH}"
          export PATH="${HERE}/usr/bin:${PATH}"

          # Debug output (comment out for production)
          # echo "LD_LIBRARY_PATH: $LD_LIBRARY_PATH"
          # ldd "${HERE}/usr/bin/BASIL" | grep python

          exec "${HERE}/usr/bin/BASIL" "$@"
          EOF
          chmod +x AppDir/AppRun
          chmod +x AppDir/usr/bin/BASIL

          # Verify structure
          echo "=== AppDir structure ==="
          ls -la AppDir/usr/lib/
          ls -la AppDir/usr/bin/ | head -20

      - name: Build AppImage
        run: |
          VERSION=${{ github.event.inputs.version || github.event.release.tag_name || '1.0.0' }}
          ARCH=x86_64 ./appimagetool-x86_64.AppImage AppDir BASIL-v${VERSION}-x86_64.AppImage
          chmod +x BASIL-v${VERSION}-x86_64.AppImage

      - name: Verify AppImage
        run: |
          VERSION=${{ github.event.inputs.version || github.event.release.tag_name || '1.0.0' }}
          ls -lh BASIL-v${VERSION}-x86_64.AppImage
          file BASIL-v${VERSION}-x86_64.AppImage

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-x86_64
          path: BASIL-*.AppImage

  create-release:
    needs: [build-windows, create-universal-binary, build-linux]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: List downloaded artifacts for debugging
        run: |
          echo "Downloaded artifacts:"
          find . -type f
          echo ""
          echo "File sizes:"
          find . -type f -exec ls -lh {} \;

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            windows-x86/*.exe
            windows-x64/*.exe
            macos-universal/*.dmg
            linux-x86_64/*.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
